{
  "hash": "1251ace083e721f24730ef8219412d0e",
  "result": {
    "markdown": "---\ntitle: \"ערכים לפני ואחרי נקודת זמן\"\ndescription: |\n  החזרת ציון 'סכנת עזיבה' לפני התשלום הראשון ומיד לאחריו\nauthor: \"\"\ndate: \"2023-11-09\"\ntoc: true\ncategories: [בסיסי]\nimage: featured.png\ndraft: false\nfilters:\n  - interactive-sql\ndatabases:\n  - name: q4db\n    path: \"https://raw.githubusercontent.com/AmitLevinson/sql-website/main/questions/4-before-and-after/q4_db.sql\"\n---\n\n\n\n\n\n\nברוכים הבאים לתרגיל הרביעי!\n\n## הדאטה\n\nהתרגיל מורכב מ-2 טבלאות: טבלת תשלומים וטבלת ציוני 'סכנת נטישה' (עוד הסבר למטה). \n\nטבלת תשלומים:\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nSELECT TOP 5 * \nFROM payments_ag_4\norder by payment_date;\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: 5 records\n\n| user_id|payment_date | amount|\n|-------:|:------------|------:|\n|       1|2022-10-13   |   71.7|\n|       2|2022-10-14   |   73.9|\n|       4|2022-10-14   |   52.6|\n|       4|2022-10-16   |   42.0|\n|       5|2022-10-19   |   62.5|\n\n</div>\n:::\n\n\nטבלת ציוני סכנת נטישה:\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nSELECT TOP 5 * \nFROM churn_scores_ag_4\norder by score_date;\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: 5 records\n\n| user_id|score_date | churn_score|\n|-------:|:----------|-----------:|\n|       2|2022-08-01 |          70|\n|       3|2022-08-03 |          39|\n|       3|2022-08-04 |           9|\n|       3|2022-08-04 |         100|\n|       1|2022-08-08 |          64|\n\n</div>\n:::\n\n\n\n\n## שאלה 1\n\nלכל יוזר יש ציוני 'סכנת נטישה' המעידים על הסיכוי של אותו יוזר לנטוש את הפלטפורמה לנקודת זמן מסוימת (נע בין 1-100, כאשר ציון גבוה יותר מעיד על סיכוי גבוה יותר לנטישה).\n\nעבור כל יוזר יש לחלץ את התשלום הראשון שקיבל ושני *תאריכי* סכנת נטישה: התאריך המאוחר ביותר שמתועד *לפני* קבלת התשלום הראשון, והתאריך המוקדם ביותר שמתועד *לאחר* התשלום הראשון.\n\n### דוגמא\n\n\n<details>\n<summary>לחץ להצגת הדוגמא</summary>\n\n<br>\n\nלדוג', להלן טבלת ציוני 'סכנת נטישה' ליוזר כלשהו:\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nSELECT TOP 5 * \nFROM churn_scores_ag_4\nwhere user_id = 1\norder by score_date;\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: 5 records\n\n| user_id|score_date | churn_score|\n|-------:|:----------|-----------:|\n|       1|2022-08-08 |          64|\n|       1|2022-09-11 |          29|\n|       1|2022-11-01 |          23|\n|       1|2022-11-17 |          91|\n|       1|2022-12-05 |          36|\n\n</div>\n:::\n\n\nולהלן דגימה מתוך התשלומים הראשונים שלו:\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nSELECT TOP 5 * \nFROM payments_ag_4\nwhere user_id = 1\norder by payment_date;\n```\n\n\n<div class=\"knitsql-table\">\n\n\nTable: 3 records\n\n| user_id|payment_date | amount|\n|-------:|:------------|------:|\n|       1|2022-10-13   |   71.7|\n|       1|2022-11-10   |   61.8|\n|       1|2022-11-13   |    4.0|\n\n</div>\n:::\n\n\nניתן לראות שהציון 'סכנת נטישה' המאוחר ביותר לפני התשלום הראשוני באוקטובר 2022 הוא 2022-09-11 ואילו ציון 'סכנת נטישה' המוקדם ביותר לאחר התשלום הראשוני הוא 2022-11-01\n\n\nלכן, אנחנו נרצה להחזיר את הרשומה הבאה ליוזר 1:\n\n\n::: {.cell}\n<div class=\"knitsql-table\">\n\n\nTable: 1 records\n\n| user_id|score_date_before_paymet |first_payment |score_date_after_paymet |\n|-------:|:------------------------|:-------------|:-----------------------|\n|       1|2022-09-11               |2022-10-13    |2022-11-01              |\n\n</div>\n:::\n\n\n\n\n</details>\n\n## שאלה 2 \n\nצרו פלט נוסף שבו במקום תאריכים מופיעים ציוני סכנת הנטישה (הציון לפני התשלום הראשון והציון מיד לאחר התשלום הראשון)\n\n\n\n## נסו בעצמכם\n\n### אונליין \n\n<mark>נסו בחלון טקסט למטה (SQLite):</mark>\n\n```{.sql .interactive .q4db}\n-- EDIT THIS QUERY:\n--SELECT *\n--FROM churn_scores_ag_4\n--LIMIT 10;\n\nSELECT *\nFROM payments_ag_4\nLIMIT 10;\n\n```\n\n\n### נסו על המחשב שלכם\n\n<details>\n<summary>הצג קוד ליצירת טבלה</summary>\n\n#### תשלומים\n\n\n::: {.cell}\n\n```{.sql .cell-code style=\"max-height: 200px;overflow: scroll;\"}\n\ncreate table payments_ag_4 (\n\tuser_id INT,\n\tpayment_date DATE,\n\tamount DECIMAL(4,1)\n);\ninsert into payments_ag_4 (user_id, payment_date, amount) values (4, '11/26/2022', 89.7);\ninsert into payments_ag_4 (user_id, payment_date, amount) values (5, '11/29/2022', 57.5);\ninsert into payments_ag_4 (user_id, payment_date, amount) values (4, '10/14/2022', 52.6);\ninsert into payments_ag_4 (user_id, payment_date, amount) values (5, '12/3/2022', 18.3);\ninsert into payments_ag_4 (user_id, payment_date, amount) values (2, '10/14/2022', 73.9);\ninsert into payments_ag_4 (user_id, payment_date, amount) values (5, '11/30/2022', 4.2);\ninsert into payments_ag_4 (user_id, payment_date, amount) values (1, '11/13/2022', 4.0);\ninsert into payments_ag_4 (user_id, payment_date, amount) values (2, '11/9/2022', 97.3);\ninsert into payments_ag_4 (user_id, payment_date, amount) values (3, '10/22/2022', 4.6);\ninsert into payments_ag_4 (user_id, payment_date, amount) values (4, '10/16/2022', 42.0);\ninsert into payments_ag_4 (user_id, payment_date, amount) values (4, '12/6/2022', 89.6);\ninsert into payments_ag_4 (user_id, payment_date, amount) values (5, '11/29/2022', 36.9);\ninsert into payments_ag_4 (user_id, payment_date, amount) values (5, '10/19/2022', 62.5);\ninsert into payments_ag_4 (user_id, payment_date, amount) values (1, '11/10/2022', 61.8);\ninsert into payments_ag_4 (user_id, payment_date, amount) values (2, '10/31/2022', 17.5);\ninsert into payments_ag_4 (user_id, payment_date, amount) values (2, '11/10/2022', 5.7);\ninsert into payments_ag_4 (user_id, payment_date, amount) values (1, '10/13/2022', 71.7);\ninsert into payments_ag_4 (user_id, payment_date, amount) values (2, '11/2/2022', 35.8);\ninsert into payments_ag_4 (user_id, payment_date, amount) values (4, '11/21/2022', 52.3);\ninsert into payments_ag_4 (user_id, payment_date, amount) values (2, '10/19/2022', 31.2);\n```\n:::\n\n\n#### ציון סכנת נטישה\n\n\n\n::: {.cell}\n\n```{.sql .cell-code style=\"max-height: 200px;overflow: scroll;\"}\n\ndrop table if exists churn_scores_ag_4;\n\ncreate table churn_scores_ag_4 (\n\tuser_id INT,\n\tscore_date DATE,\n\tchurn_score INT\n);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (1, '4/3/2023', 11);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (2, '1/1/2023', 97);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (1, '11/17/2022', 91);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (1, '4/23/2023', 84);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '12/9/2022', 92);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (1, '2/22/2023', 7);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '4/27/2023', 19);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (2, '9/1/2022', 42);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '11/26/2022', 69);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '12/16/2022', 38);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (2, '3/27/2023', 22);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (5, '3/21/2023', 32);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '2/2/2023', 55);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (1, '2/26/2023', 57);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (1, '2/3/2023', 24);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (5, '4/22/2023', 98);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (2, '10/13/2022', 38);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (5, '11/23/2022', 77);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '10/6/2022', 31);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '8/31/2022', 92);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (1, '12/21/2022', 97);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '10/22/2022', 49);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '1/3/2023', 60);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '3/29/2023', 93);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '1/9/2023', 81);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (5, '10/25/2022', 72);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (5, '3/9/2023', 97);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (5, '3/19/2023', 91);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (1, '2/28/2023', 9);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (1, '2/19/2023', 2);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (1, '3/23/2023', 29);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '11/13/2022', 80);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '3/18/2023', 24);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '3/31/2023', 34);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (2, '1/4/2023', 68);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '2/3/2023', 10);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '11/2/2022', 40);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (1, '2/26/2023', 37);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (5, '11/30/2022', 59);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (1, '8/8/2022', 64);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '8/4/2022', 9);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '8/3/2022', 39);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (5, '1/28/2023', 83);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '8/27/2022', 49);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (2, '12/28/2022', 3);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (1, '3/15/2023', 73);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '4/30/2023', 57);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '1/21/2023', 36);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (1, '9/11/2022', 29);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (5, '8/15/2022', 4);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (2, '3/6/2023', 78);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '10/22/2022', 58);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (5, '11/3/2022', 14);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (2, '8/1/2022', 70);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '10/27/2022', 42);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (5, '3/6/2023', 19);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '8/4/2022', 100);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (1, '2/21/2023', 15);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (5, '9/10/2022', 31);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (1, '1/2/2023', 44);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '8/18/2022', 35);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (2, '10/22/2022', 4);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (1, '3/21/2023', 29);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (2, '8/15/2022', 79);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '2/25/2023', 44);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (2, '1/21/2023', 87);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (2, '1/14/2023', 81);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (5, '10/24/2022', 99);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '12/7/2022', 54);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (5, '3/13/2023', 39);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (2, '9/9/2022', 10);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (1, '11/1/2022', 23);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (2, '2/28/2023', 88);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '3/29/2023', 85);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (2, '12/3/2022', 8);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '1/22/2023', 24);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '3/19/2023', 6);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '9/30/2022', 89);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (2, '2/5/2023', 33);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '4/15/2023', 59);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (5, '1/13/2023', 59);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '3/16/2023', 63);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (5, '8/26/2022', 89);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '12/31/2022', 70);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (2, '12/21/2022', 100);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '4/27/2023', 91);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '8/29/2022', 100);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (2, '9/11/2022', 99);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '9/27/2022', 4);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (1, '12/5/2022', 36);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (5, '9/24/2022', 18);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '9/19/2022', 68);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (5, '12/7/2022', 72);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '12/25/2022', 72);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (5, '1/6/2023', 8);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (5, '9/14/2022', 6);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '2/1/2023', 11);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (4, '9/14/2022', 10);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (2, '3/27/2023', 82);\ninsert into churn_scores_ag_4 (user_id, score_date, churn_score) values (3, '11/27/2022', 90);\n\n```\n:::\n\n\n</details>\n\n## תשובות\n\n### סרטון הסבר\n\n\n{{< video https://youtu.be/iBklZWzFN2s >}}\n\n\n\n\n### תשובה 1\n\n<details>\n<summary>הצג פתרון</summary>\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nWITH user_payment as (\n  SELECT user_id,\n    min(payment_date) as first_payment\n  FROM payments_ag_4\n  GROUP BY user_id\n  )\n\nSELECT user_payment.user_id,\n  max(CASE WHEN first_payment > score_date then score_date END) as score_date_before_paymet,\n  first_payment,\n  min(CASE WHEN first_payment < score_date then score_date END) as score_date_after_paymet\nFROM user_payment  \nLEFT JOIN churn_scores_ag_4 scores on scores.user_id = user_payment.user_id\nGROUP BY user_payment.user_id, first_payment;\n```\n:::\n\n\n</details>\n\n\n\n::: {.cell}\n<div class=\"knitsql-table\">\n\n\nTable: 5 records\n\n|user_id |score_date_before_paymet |first_payment |score_date_after_paymet |\n|:-------|:------------------------|:-------------|:-----------------------|\n|1       |2022-09-11               |2022-10-13    |2022-11-01              |\n|2       |2022-10-13               |2022-10-14    |2022-10-22              |\n|3       |2022-09-19               |2022-10-22    |2022-10-27              |\n|4       |2022-10-06               |2022-10-14    |2022-10-22              |\n|5       |2022-09-24               |2022-10-19    |2022-10-24              |\n\n</div>\n:::\n\n### תשובה 2\n\n<details>\n<summary>הצג פתרון</summary>\n\nשימו לב, הפתרון נכתב בסינטקס T-SQL ולא יעבוד בתיבת טקסט להרצת SQL למעלה. מוזמנים להיעזר בתגובות למציאת פתרון מתאים ל-SQLite.\n\n\n::: {.cell}\n\n```{.sql .cell-code}\nWITH user_payment as (\n  SELECT user_id,\n    min(payment_date) as first_payment\n  FROM payments_ag_4\n  GROUP BY user_id\n  )\n\nSELECT user_payment.user_id,\n   first_payment,\n  churn_scores.score_before_payment,\n  churn_scores.score_after_payment\nFROM user_payment\nOUTER APPLY (\n  SELECT top 1\n   FIRST_VALUE(churn_score) OVER(ORDER BY CASE WHEN score_date < first_payment THEN 1 ELSE 2 END, score_date desc) as score_before_payment,\n   FIRST_VALUE(churn_score) OVER(ORDER BY CASE WHEN score_date > first_payment THEN 1 ELSE 2 END, score_date asc)  as score_after_payment \n  from churn_scores_ag_4 scores\n  where scores.user_id = user_payment.user_id\n) AS churn_scores\n```\n:::\n\n\n</details>\n\n\n::: {.cell}\n<div class=\"knitsql-table\">\n\n\nTable: 5 records\n\n|user_id |first_payment | score_before_payment| score_after_payment|\n|:-------|:-------------|--------------------:|-------------------:|\n|1       |2022-10-13    |                   29|                  23|\n|2       |2022-10-14    |                   38|                   4|\n|3       |2022-10-22    |                   68|                  42|\n|4       |2022-10-14    |                   31|                  49|\n|5       |2022-10-19    |                   18|                  99|\n\n</div>\n:::\n\n::: {.cell}\n\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}